trigger:
  branches:
    include:
      - main  # Override this variable in Azure DevOps to specify the branch

variables:
  - name: branch
    value: 'main'  # Default value, can be overridden during pipeline run
  - name: pantheon-branch
    value: 'main'  # Default value, can be overridden during pipeline run

pool:
  name: 'azureagent'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildAndDeploy
    displayName: 'Build and Deploy'
    steps:
    - checkout: self

    - script: |
        echo "Running build steps..."
        # Add your build commands here
      displayName: 'Build Step'

- stage: DeployToProduction
  displayName: 'Deploy to Production'
  dependsOn: Build
  condition: or( eq(variables['branch'], 'master'),eq(variables['pantheon-branch'], 'master'))
   
  jobs:
  - job: manual_approval
    displayName: "Manual Approval"
    pool:
      name: 'server'
    condition: or(eq(variables['branch'], 'master'), eq(variables['pantheon-branch'], 'master'))
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: 'Deployment to master branch requires manual approval. Please review and approve to continue.'
        onTimeout: 'resume'
        notifyUsers: "sa"
      displayName: 'Manual Intervention for Master Branch Deployment'

  - deployment: DeployToProduction
    displayName: 'Deploy to Production'
    dependsOn: manual_approval
    condition: and(succeeded('manual_approval'),or(eq(variables['branch'], 'master'), eq(variables['pantheon-branch'], 'master')))
    environment: 'main-dev'
    pool:
      vmImage: $vmImageName  # Ensure this variable is defined
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "Running deployment steps..."
            displayName: 'Deployment Step'
